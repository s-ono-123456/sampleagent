## シート名: 受注管理_初期表示

外部設計書

| ドキュメント名 | 作成日／更新日 | 版 | 作成者／更新者 |
|---|---|---|---|
| 外部設計書_画面設計（受注管理） | 2025-04-19 | 1.0.0 | あなたのお名前 |

### 1. 前処理

#### 1.1. 権限チェック

・ログインユーザーの権限をチェックする。  
・受注管理画面へのアクセス権限を確認。

#### 1.2. リクエスト情報取得

・画面に表示する受注情報を取得する。

| ＃ | エリア名 | 画面項目名 |
|---|---|---|
| 1 | ヘッダー | 検索条件（受注番号、受注日、顧客名） |
| 2 | 本体 | 受注一覧テーブル（受注番号、受注日、顧客名、合計金額、ステータス） |

### 2. チェック処理

#### 2.1. アクセス権限チェック
・ユーザーが受注管理画面へのアクセス権限を持っているか確認。
・権限がない場合はエラーメッセージを表示し、メインメニューに遷移。

#### 2.2. セッション有効性チェック
・ユーザーセッションが有効であることを確認。
・タイムアウトしている場合はログイン画面にリダイレクト。

#### 2.3. 検索条件チェック（初期表示時）
・初期表示時のデフォルト検索条件（例: 過去30日間の受注）の範囲が適切か確認。
・大量データ取得による性能低下を防ぐため、検索期間が過度に長くないかチェック。

### 3. 業務処理

#### 3.1. データ取得処理

##### 3.1.1. DBからデータを取得

| ＃ | DB名 | 画面項目名 |
|---|---|---|
| 1 | 受注 | 受注番号 |
| 2 | 受注 | 受注日 |
| 3 | 顧客 | 顧客名 |
| 4 | 受注明細 | 合計金額 |
| 5 | 受注 | ステータス |

#### 3.2. データ成形処理

##### 3.2.1. データ成型

・検索条件に一致する受注データを整形。

##### 3.2.2. 後処理

・取得データを画面表示形式に整形し表示。

---

## シート名: 受注管理_詳細表示ボタン

外部設計書

### 1. 前処理

#### 1.1. 権限チェック

・詳細表示の権限を確認。

#### 1.2. リクエスト情報取得

| ＃ | エリア名 | 画面項目名 |
|---|---|---|
| 1 | 本体 | 選択行の受注番号 |

### 2. チェック処理

#### 2.1. 受注番号存在チェック
・指定された受注番号のデータが存在するか確認。
・存在しない場合は「指定された受注情報は見つかりません」というメッセージを表示。

#### 2.2. 参照権限チェック
・ログインユーザーがその受注データの参照権限を持っているか確認（部門制限がある場合など）。
・権限がない場合は「この受注情報を参照する権限がありません」というメッセージを表示。

#### 2.3. データ整合性チェック
・受注ヘッダと受注明細の整合性を確認（明細が存在するか、合計金額が一致するかなど）。
・不整合がある場合は警告メッセージを表示し、管理者への通知フラグを立てる。

### 3. 業務処理

#### 3.1. 受注詳細取得処理

・受注番号をキーに、受注情報および受注明細をDBから取得。
・取得した情報を詳細表示用データ形式に整形。
・モーダルダイアログまたは別画面に表示する。

---

## シート名: 受注管理_受注確定ボタン

外部設計書

### 1. 前処理

#### 1.1. 権限チェック

・受注確定操作の権限を確認。

#### 1.2. リクエスト情報取得

| ＃ | エリア名 | 画面項目名 |
|---|---|---|
| 1 | 本体 | 受注番号 |

### 2. チェック処理

#### 2.1. 受注状態チェック
・対象の受注が「仮登録」状態であることを確認。
・「確定」「キャンセル」などの状態では操作できないことを表示。

#### 2.2. 必須項目チェック
・受注を確定するために必要な情報（配送先、支払い方法など）がすべて入力されているか確認。
・不足している場合は「確定に必要な情報が不足しています: [不足項目]」というメッセージを表示。

#### 2.3. 在庫チェック
・各明細商品について、現在の在庫数が注文数量を満たしているか確認。
・在庫不足の場合は「[商品名]の在庫が不足しています（必要数: [数量]、在庫数: [在庫数]）」というメッセージを表示。

#### 2.4. 金額上限チェック
・受注金額が承認不要の上限（例: 100万円）を超えていないか確認。
・超過している場合は「金額が承認上限を超えています。上長の承認が必要です」というメッセージを表示。

#### 2.5. 与信チェック
・顧客の与信限度額内であることを確認。
・未入金の受注がある場合など、与信上の問題があれば警告表示。

### 3. 業務処理

#### 3.1. ステータス更新処理

・受注テーブルのステータスを「確定」に更新。
・確定日時と確定ユーザーIDを記録。
・更新結果を画面に反映。

---

## シート名: 受注管理_受注明細編集ボタン

外部設計書

### 1. 前処理

#### 1.1. 権限チェック

・明細編集の権限があるか確認。

#### 1.2. リクエスト情報取得

・編集対象の受注番号および明細情報を取得。

### 2. チェック処理

#### 2.1. 受注状態チェック
・対象の受注が編集可能な状態（「仮登録」など）であることを確認。
・「確定」「出荷済み」などの状態では編集できないことを表示。

#### 2.2. 入力値チェック
・商品コード：半角英数字、最大20文字であることを確認。
・数量：1以上の整数であること、上限（9999）を超えていないことを確認。
・単価：0以上の数値であること、上限（9,999,999）を超えていないことを確認。
・値引き：0以上の数値で、元価格を超えていないことを確認。

#### 2.3. データ整合性チェック
・商品コードが商品マスタに存在することを確認。
・存在しない場合は「商品コード[コード]は登録されていません」というメッセージを表示。

#### 2.4. 業務ルールチェック
・最低注文金額（例: 3,000円）を満たしていることを確認。
・下回る場合は「注文金額が最低金額（3,000円）を下回っています」という警告を表示。

### 3. 業務処理

#### 3.1. 明細更新処理

・入力内容に基づき受注明細を一括更新（既存データは削除して再登録）。
・受注テーブルの合計金額を再計算。
・更新後、再取得して画面に反映。

---

## シート名: 受注管理_削除ボタン

外部設計書

### 1. 前処理

#### 1.1. 権限チェック

・削除権限を確認。

#### 1.2. リクエスト情報取得

・削除対象の受注番号を取得。

### 2. チェック処理

#### 2.1. 受注状態チェック
・対象の受注が削除可能な状態（「仮登録」など）であることを確認。
・「確定」「出荷準備中」「出荷済み」などの状態では削除できないことを表示。

#### 2.2. 削除権限チェック
・ログインユーザーがその受注データの削除権限を持っているか確認。
・権限がない場合は「この受注情報を削除する権限がありません」というメッセージを表示。

#### 2.3. 関連処理チェック
・削除対象の受注に関連する処理（発送準備など）が進行中でないことを確認。
・関連処理がある場合は「この受注は現在処理中のため削除できません」というメッセージを表示。

#### 2.4. 確認ダイアログ表示
・削除確認メッセージを表示し、ユーザーの最終確認を得る。
・メッセージには削除する受注番号、顧客名、金額などの重要情報を含め、誤操作を防止する。

### 3. 業務処理

#### 3.1. 論理削除処理

・受注テーブルおよび受注明細テーブルの削除フラグをONに設定。
・削除ユーザー、削除日時を記録。
・削除後、一覧から該当行を非表示とする。

---

## シート名: 受注管理_CSV出力ボタン

外部設計書

### 1. 前処理

#### 1.1. 権限チェック

・CSV出力権限を確認。

#### 1.2. リクエスト情報取得

・検索条件を取得。

### 2. チェック処理

#### 2.1. 出力権限チェック
・ログインユーザーがCSVデータを出力する権限を持っているか確認。
・権限がない場合は「CSVデータを出力する権限がありません」というメッセージを表示。

#### 2.2. 検索条件チェック
・検索条件の日付範囲が適切か確認（例: 1年以上の範囲指定は不可）。
・範囲が広すぎる場合は「出力可能な日付範囲は最大12ヶ月です」というメッセージを表示。

#### 2.3. データ量チェック
・出力対象のデータ件数が上限（例: 10,000件）を超えていないか確認。
・超過している場合は「出力件数が上限を超えています。検索条件を絞り込んでください」というメッセージを表示。

#### 2.4. 出力項目確認
・出力対象の項目（標準/詳細）が選択されているか確認。
・選択がない場合はデフォルト（標準）を適用する。

### 3. 業務処理

#### 3.1. CSVデータ生成処理

・条件に合致する受注データを取得。
・CSVフォーマット（ヘッダー、エンコーディング）に従ってファイル生成。
・ユーザーへダウンロードリンクを返却。

