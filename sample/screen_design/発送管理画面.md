## シート名: 発送管理_初期表示

外部設計書

| ドキュメント名 | 作成日／更新日 | 版 | 作成者／更新者 |
|---|---|---|---|
| 外部設計書_画面設計（発送管理） | 2025-04-19 | 1.0.0 | あなたのお名前 |

### 1. 前処理

#### 1.1. 権限チェック

・ログインユーザーの権限をチェックする。
・発送管理画面へのアクセス権限を確認。

#### 1.2. リクエスト情報取得

・画面に表示する発送情報を取得する。

| ＃ | エリア名 | 画面項目名 |
|---|---|---|
| 1 | ヘッダー | 検索条件（発送番号、受注番号、発送日、ステータス） |
| 2 | 本体 | 発送一覧テーブル（発送番号、受注番号、顧客名、発送日、配送業者、ステータス） |

### 2. チェック処理

#### 2.1. アクセス権限チェック
・ユーザーが発送管理画面へのアクセス権限を持っているか確認。
・権限がない場合はエラーメッセージを表示し、メインメニューに遷移。

#### 2.2. セッション有効性チェック
・ユーザーセッションが有効であることを確認。
・タイムアウトしている場合はログイン画面にリダイレクト。

#### 2.3. 検索条件チェック（初期表示時）
・初期表示時のデフォルト検索条件（例: 発送予定日が当日以降のデータ）の範囲が適切か確認。
・大量データ取得による性能低下を防ぐため、検索期間が過度に長くないかチェック。

#### 2.4. 表示データ量チェック
・初期表示時のデータ量が適切か確認（表示上限：500件）。
・大量データの場合、パフォーマンス低下を防ぐためにページング表示を適用。

### 3. 業務処理

#### 3.1. データ取得処理

##### 3.1.1. DBからデータを取得

| ＃ | DB名 | 画面項目名 |
|---|---|---|
| 1 | 発送 | 発送番号 |
| 2 | 受注 | 受注番号 |
| 3 | 顧客 | 顧客名 |
| 4 | 発送 | 発送日 |
| 5 | 発送 | 配送業者 |
| 6 | 発送 | ステータス |

#### 3.2. データ成形処理

##### 3.2.1. データ成型

・検索条件に一致する発送データを整形。

##### 3.2.2. 後処理

・取得データを画面表示形式に整形し表示。

---

## シート名: 発送管理_発送確定ボタン

### 1. 前処理

#### 1.1. 権限チェック

・発送確定処理の実行権限を確認。

#### 1.2. リクエスト情報取得

| ＃ | エリア名 | 画面項目名 |
|---|---|---|
| 1 | 本体 | 発送番号 |

### 2. チェック処理

#### 2.1. 受注状態チェック
・発送対象となる受注が「出荷準備完了」状態であることを確認。
・該当するステータスでない場合は「この受注は発送確定処理ができない状態です」というメッセージを表示。

#### 2.2. 必須項目チェック
・配送業者：選択されていることを確認。
・発送日：入力されており、妥当な日付（当日以降）であることを確認。
・追跡番号：入力されている場合、形式が正しいことを確認（配送業者ごとに異なる形式）。
・不足している場合は「発送確定には[不足項目]の入力が必要です」というメッセージを表示。

#### 2.3. 発送済チェック
・既に発送済みでないことを確認。
・発送済みの場合は「この受注は既に発送済みです」というメッセージを表示。

#### 2.4. 権限チェック
・ログインユーザーが発送確定処理を実行する権限を持っているか確認。
・権限がない場合は「発送確定処理を実行する権限がありません」というメッセージを表示。

#### 2.5. 配送業者連携チェック
・選択された配送業者のシステムと連携が可能な状態であることを確認（該当する場合）。
・連携不可の場合は「配送業者システムとの連携ができません。ネットワーク状態を確認してください」というメッセージを表示。

### 3. 業務処理

#### 3.1. ステータス更新処理

・ステータスを「確定」に更新。
・発送確定日時・担当者を記録。
・一覧に反映。

---

## シート名: 発送管理_キャンセルボタン

### 1. 前処理

#### 1.1. 権限チェック

・キャンセル処理の実行権限を確認。

#### 1.2. リクエスト情報取得

・キャンセル対象の発送番号を取得。

### 2. チェック処理

#### 2.1. 発送状態チェック
・キャンセル対象の発送が「未配送」または「準備中」状態であることを確認。
・「配送中」「配送完了」などの状態ではキャンセルできないことを表示。

#### 2.2. 出荷作業進行状況チェック
・発送の梱包作業や配送業者連携などが開始されていないことを確認。
・作業が進行中の場合は「出荷作業が進行中のため、キャンセルできません」というメッセージを表示。

#### 2.3. 権限チェック
・ログインユーザーが発送キャンセル処理を実行する権限を持っているか確認。
・権限がない場合は「発送キャンセル処理を実行する権限がありません」というメッセージを表示。

#### 2.4. キャンセル理由チェック
・キャンセル理由が入力されているか確認。
・未入力の場合は「キャンセル理由を入力してください」というメッセージを表示。

#### 2.5. 確認ダイアログ表示
・キャンセル確認メッセージを表示し、ユーザーの最終確認を得る。
・メッセージにはキャンセルする発送番号、受注番号、顧客名などの重要情報を含め、誤操作を防止する。

### 3. 業務処理

#### 3.1. ステータス更新処理

・ステータスを「キャンセル」に変更。
・キャンセル理由、日時、担当者情報を記録。

---

## シート名: 発送管理_伝票出力ボタン

### 1. 前処理

#### 1.1. 権限チェック

・伝票出力の実行権限を確認。

#### 1.2. リクエスト情報取得

・発送番号を取得。

### 2. チェック処理

#### 2.1. 発送状態チェック
・伝票出力対象の発送が存在し、有効状態であることを確認。
・キャンセルされた発送の場合は「キャンセルされた発送の伝票は出力できません」というメッセージを表示。

#### 2.2. 必須情報チェック
・伝票出力に必要な情報（配送先住所、顧客名、商品情報など）が揃っていることを確認。
・不足情報がある場合は「伝票出力に必要な[不足項目]が未入力です」というメッセージを表示。

#### 2.3. 権限チェック
・ログインユーザーが伝票出力を実行する権限を持っているか確認。
・権限がない場合は「伝票出力を実行する権限がありません」というメッセージを表示。

#### 2.4. 伝票出力回数チェック
・既に出力済みの場合、再出力であることを確認。
・再出力時は履歴に記録し、「この伝票は再出力です」という透かしを入れるかどうかの確認ダイアログを表示。

#### 2.5. プリンター状態チェック（該当する場合）
・プリンターが使用可能であることを確認。
・不可の場合は「プリンターが使用できません。プリンターの状態を確認してください」というメッセージを表示。

### 3. 業務処理

#### 3.1. 伝票PDF生成処理

・対象発送の伝票情報（顧客名、配送先、商品情報など）を取得。
・フォーマットに従いPDFを生成。
・ダウンロードリンクとして返却。

---

## シート名: 発送管理_配送状況確認ボタン

### 1. 前処理

#### 1.1. 権限チェック

・配送状況確認の権限を確認。

#### 1.2. リクエスト情報取得

・発送番号および配送業者情報を取得。

### 2. チェック処理

#### 2.1. 発送状態チェック
・対象の発送が「発送済み」状態であることを確認。
・未発送の場合は「この発送はまだ発送されていないため、配送状況を確認できません」というメッセージを表示。

#### 2.2. 追跡番号チェック
・追跡番号が入力されていることを確認。
・未入力の場合は「追跡番号が登録されていないため、配送状況を確認できません」というメッセージを表示。

#### 2.3. 配送業者チェック
・配送業者が選択されており、その配送業者の追跡サービスが利用可能であることを確認。
・利用不可の場合は「この配送業者の追跡サービスは現在利用できません」というメッセージを表示。

#### 2.4. 外部API接続チェック
・配送業者のAPIまたは追跡サービスに接続可能であることを確認。
・接続不可の場合は「配送業者の追跡サービスに接続できません。ネットワーク状態を確認してください」というメッセージを表示。

#### 2.5. 権限チェック
・ログインユーザーが配送状況を確認する権限を持っているか確認。
・権限がない場合は「配送状況を確認する権限がありません」というメッセージを表示。

### 3. 業務処理

#### 3.1. 配送API連携処理

・配送業者APIまたは外部トラッキングURLに発送番号を連携。
・取得結果（配送ステータスや履歴）をモーダルまたは別ウィンドウで表示。

---

## シート名: 発送管理_CSV出力ボタン

### 1. 前処理

#### 1.1. 権限チェック

・CSV出力の実行権限を確認。

#### 1.2. リクエスト情報取得

・検索条件を取得。

### 2. チェック処理

#### 2.1. 出力権限チェック
・ログインユーザーがCSVデータを出力する権限を持っているか確認。
・権限がない場合は「CSVデータを出力する権限がありません」というメッセージを表示。

#### 2.2. 検索条件チェック
・検索条件の日付範囲が適切か確認（例: 1年以上の範囲指定は不可）。
・範囲が広すぎる場合は「出力可能な日付範囲は最大12ヶ月です」というメッセージを表示。

#### 2.3. データ量チェック
・出力対象のデータ件数が上限（例: 10,000件）を超えていないか確認。
・超過している場合は「出力件数が上限を超えています。検索条件を絞り込んでください」というメッセージを表示。

#### 2.4. 出力項目確認
・出力対象の項目（標準/詳細）が選択されているか確認。
・選択がない場合はデフォルト（標準）を適用する。

#### 2.5. 機密情報含有チェック
・出力データに機密情報（顧客の電話番号、メールアドレスなど）が含まれる場合、確認メッセージを表示。
・「出力データには個人情報が含まれます。社内規定に従って適切に取り扱ってください」という警告を表示。

### 3. 業務処理

#### 3.1. CSVファイル生成処理

・検索条件に一致する発送データを取得。
・CSVフォーマットに変換（列順、エンコーディング設定）。
・ユーザーへファイルダウンロード提供。

