## バッチ名: 発送データ作成バッチ

外部設計書

| ドキュメント名 | 作成日／更新日 | 版 | 作成者／更新者 |
|---|---|---|---|
| 外部設計書_バッチ設計（発送データ作成） | 2025-04-26 | 1.0.0 | あなたのお名前 |

### 1. 前処理

#### 1.1. 権限チェック

・バッチ実行アカウントの権限をチェックする。  
・データベース接続権限を確認。

#### 1.2. パラメータ取得

・発送データ作成処理に必要なパラメータを取得する。

| ＃ | パラメータ名 | 説明 |
|---|---|---|
| 1 | 実行日 | バッチ実行日（YYYY-MM-DD形式） |
| 2 | 発送対象受注日数 | 発送対象とする確定済み受注の日数（デフォルト：3日） |
| 3 | 配送業者設定ファイル | 配送業者の設定情報CSVファイルパス |

### 2. チェック処理

#### 2.1. パラメータ妥当性チェック

・実行日のフォーマットを確認。
・配送業者設定ファイルが存在することを確認。

### 3. 業務処理

#### 3.1. 発送対象受注抽出

##### 3.1.1. 対象受注データ取得

・受注ステータスが「確定」で発送ステータスが未設定の受注を抽出。
・指定された日数以内（現在日付-発送対象受注日数）の受注を対象とする。
・キャンセル済み受注は対象外。

##### 3.1.2. 在庫引当確認

・対象商品の在庫引当が完了しているかを確認。
・在庫引当が未完了の受注は対象外としてログに出力。

#### 3.2. 配送業者選定

##### 3.2.1. 配送業者設定取得

・配送業者設定ファイルから配送条件（地域、サイズ、重量など）を取得。

##### 3.2.2. 最適配送業者選定

・配送先、荷物サイズ、重量などから最適な配送業者を選定。
・特殊配送条件（冷蔵・冷凍、時間指定など）がある場合は対応可能な業者を選定。

#### 3.3. 発送データ作成

##### 3.3.1. トランザクション開始

・DB登録処理のトランザクション開始。

##### 3.3.2. 発送テーブル登録

・発送番号（自動採番）、受注番号、顧客情報、配送業者情報を登録。
・発送ステータスを「準備中」として設定。
・予定発送日を設定（通常は翌営業日）。

##### 3.3.3. 受注ステータス更新

・対象受注の発送ステータスを「発送準備中」に更新。

##### 3.3.4. コミット

・エラーがなければトランザクションをコミット。

#### 3.4. 発送業務リスト作成

##### 3.4.1. CSV出力

・創出された発送データリストをCSV形式で出力。
・ファイル名：発送業務リスト_YYYYMMDD.csv
・出力項目：発送番号、受注番号、顧客名、配送先住所、商品情報、配送業者など

### 4. 後処理

#### 4.1. 倉庫担当者通知

・発送業務リストを倉庫担当者にメール通知。
・CSVファイルを添付。

#### 4.2. 処理結果ログ出力

・処理件数（対象受注数、作成発送データ数）をログ出力。
・エラー詳細情報を出力。