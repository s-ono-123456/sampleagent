## バッチ名: 発送ラベル生成バッチ

外部設計書

| ドキュメント名 | 作成日／更新日 | 版 | 作成者／更新者 |
|---|---|---|---|
| 外部設計書_バッチ設計（発送ラベル生成） | 2025-04-26 | 1.0.0 | あなたのお名前 |

### 1. 前処理

#### 1.1. 権限チェック

・バッチ実行アカウントの権限をチェックする。  
・データベース接続権限を確認。
・配送業者API連携権限を確認。

#### 1.2. パラメータ取得

・発送ラベル生成処理に必要なパラメータを取得する。

| ＃ | パラメータ名 | 説明 |
|---|---|---|
| 1 | 実行日 | バッチ実行日（YYYY-MM-DD形式） |
| 2 | 配送業者API設定ファイル | 配送業者APIの接続情報設定ファイルパス |
| 3 | 出力先パス | ラベルPDFファイルの出力先パス |

### 2. チェック処理

#### 2.1. パラメータ妥当性チェック

・実行日のフォーマットを確認。
・配送業者API設定ファイルが存在することを確認。
・出力先パスが存在しアクセス可能であることを確認。

### 3. 業務処理

#### 3.1. 対象発送データ抽出

##### 3.1.1. 未処理発送データ取得

・発送ステータスが「準備中」の発送データを抽出。
・配送業者ごとにグループ化。

##### 3.1.2. 発送情報取得

・顧客情報（氏名、住所、電話番号）を取得。
・荷物情報（重量、サイズ、個数）を取得。
・配送条件（時間指定、日付指定）を取得。

#### 3.2. 配送業者API連携

##### 3.2.1. API設定情報取得

・配送業者別のAPI接続情報（URL、認証情報など）を取得。

##### 3.2.2. 配送業者別API連携処理

・配送業者ごとに適切なAPIフォーマットでデータ送信。
・送り状番号（トラッキング番号）を取得。
・発送ラベルデータ（PDF形式）を取得。

##### 3.2.3. エラーハンドリング

・API連携エラー時の例外処理。
・リトライ処理（最大3回まで）。

#### 3.3. ラベルファイル生成

##### 3.3.1. PDFファイル保存

・取得したラベルデータをPDFファイルとして保存。
・ファイル名：発送ラベル_配送業者コード_YYYYMMDD_連番.pdf

##### 3.3.2. ラベル一覧ファイル作成

・生成されたラベルの一覧をCSV形式で作成。
・ファイル名：発送ラベル一覧_YYYYMMDD.csv
・出力項目：発送番号、受注番号、送り状番号、配送業者、ファイルパスなど

#### 3.4. DB更新

##### 3.4.1. トランザクション開始

・DB更新処理のトランザクション開始。

##### 3.4.2. 発送情報更新

・送り状番号をDBに登録。
・発送ステータスを「ラベル発行済」に更新。
・ラベルファイルパス情報を登録。

##### 3.4.3. コミット

・エラーがなければトランザクションをコミット。

### 4. 後処理

#### 4.1. 倉庫担当者通知

・ラベル生成完了を倉庫担当者にメール通知。
・ラベル一覧CSVファイルを添付。
・ラベルファイルの保存場所を通知。

#### 4.2. 処理結果ログ出力

・処理件数（対象発送数、ラベル生成成功数、失敗数）をログ出力。
・配送業者別の処理結果を出力。
・エラー詳細情報を出力。