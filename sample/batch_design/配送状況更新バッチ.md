## バッチ名: 配送状況更新バッチ

外部設計書

| ドキュメント名 | 作成日／更新日 | 版 | 作成者／更新者 |
|---|---|---|---|
| 外部設計書_バッチ設計（配送状況更新） | 2025-04-26 | 1.0.0 | あなたのお名前 |

### 1. 前処理

#### 1.1. 権限チェック

・バッチ実行アカウントの権限をチェックする。  
・データベース接続権限を確認。
・配送業者API連携権限を確認。

#### 1.2. パラメータ取得

・配送状況更新処理に必要なパラメータを取得する。

| ＃ | パラメータ名 | 説明 |
|---|---|---|
| 1 | 実行日 | バッチ実行日（YYYY-MM-DD形式） |
| 2 | 配送業者API設定ファイル | 配送業者APIの接続情報設定ファイルパス |
| 3 | 更新対象日数 | 発送後の追跡対象期間（デフォルト：7日） |

### 2. チェック処理

#### 2.1. パラメータ妥当性チェック

・実行日のフォーマットを確認。
・配送業者API設定ファイルが存在することを確認。
・更新対象日数が正の整数であることを確認。

### 3. 業務処理

#### 3.1. 対象発送データ抽出

##### 3.1.1. 追跡対象発送データ取得

・発送ステータスが「発送済」または「配送中」の発送データを抽出。
・発送日が指定された日数以内（現在日付-更新対象日数）のデータを対象とする。
・送り状番号（トラッキング番号）が設定済みのデータを対象とする。
・配送業者ごとにグループ化。

##### 3.1.2. 除外条件確認

・すでに「配達完了」または「配達失敗」ステータスになっているデータは除外。
・キャンセル済みの発送データは除外。

#### 3.2. 配送業者API連携

##### 3.2.1. API設定情報取得

・配送業者別のAPI接続情報（URL、認証情報など）を取得。

##### 3.2.2. 配送状況取得処理

・配送業者ごとに適切なAPIフォーマットで送り状番号を送信。
・最新の配送ステータス情報を取得。
・配送履歴情報（日時、場所、状態）を取得。

##### 3.2.3. エラーハンドリング

・API連携エラー時の例外処理。
・リトライ処理（最大3回まで）。
・一時的なサーバーエラーや通信エラーの場合は次回バッチで再処理。

#### 3.3. 配送状況マッピング

##### 3.3.1. ステータスコード変換

・配送業者固有の配送ステータスコードを標準ステータスに変換。
・標準ステータス：「集荷済」「配送中」「配達完了」「配達失敗」など。

##### 3.3.2. 配送履歴データ整形

・配送業者から取得した配送履歴データを標準フォーマットに変換。
・日時、場所、ステータス、コメントなどの情報を整形。

#### 3.4. DB更新

##### 3.4.1. トランザクション開始

・DB更新処理のトランザクション開始。

##### 3.4.2. 発送ステータス更新

・最新の配送ステータスをDBに更新。
・最終更新日時を記録。

##### 3.4.3. 配送履歴登録

・取得した配送履歴情報を配送履歴テーブルに登録。
・既存データがある場合は最新情報で更新。

##### 3.4.4. 特殊ステータス処理

・「配達完了」の場合は受注ステータスを「完了」に更新。
・「配達失敗」の場合はアラート情報を登録し担当者通知フラグを設定。

##### 3.4.5. コミット

・エラーがなければトランザクションをコミット。

### 4. 後処理

#### 4.1. 顧客通知処理

・配送状況が更新された場合、顧客設定に応じてメール通知。
・「配達完了」時にはお礼メールを送信。
・「配達失敗」時には対応方法の案内メールを送信。

#### 4.2. 例外状況通知

・「配達失敗」や長期間「配送中」のままなど、異常と判断される発送に対して担当者にアラートメール送信。

#### 4.3. 処理結果ログ出力

・処理件数（対象発送数、更新件数、エラー件数）をログ出力。
・配送業者別の処理結果を出力。
・エラー詳細情報を出力。