## バッチ名: 在庫自動発注バッチ

外部設計書

| ドキュメント名 | 作成日／更新日 | 版 | 作成者／更新者 |
|---|---|---|---|
| 外部設計書_バッチ設計（在庫自動発注） | 2025-04-26 | 1.0.0 | あなたのお名前 |

### 1. 前処理

#### 1.1. 権限チェック

・バッチ実行アカウントの権限をチェックする。  
・データベース接続権限を確認。

#### 1.2. パラメータ取得

・自動発注処理に必要なパラメータを取得する。

| ＃ | パラメータ名 | 説明 |
|---|---|---|
| 1 | 実行日 | バッチ実行日（YYYY-MM-DD形式） |
| 2 | 発注先設定ファイル | 商品ごとの発注先設定CSVファイルパス |
| 3 | 発注計算方法 | 発注数量計算方法（標準・季節変動・予測モデル） |

### 2. チェック処理

#### 2.1. パラメータ妥当性チェック

・実行日のフォーマットを確認。
・発注先設定ファイルが存在することを確認。
・発注計算方法が有効な値であることを確認。

### 3. 業務処理

#### 3.1. 発注対象商品抽出

##### 3.1.1. 在庫数チェック

・全商品の現在在庫数を取得。
・商品ごとの設定された発注点（最低在庫数）を取得。
・在庫数が発注点を下回っている商品を抽出。

##### 3.1.2. 発注中チェック

・すでに発注処理中の商品を除外（二重発注防止）。

#### 3.2. 発注数量計算

##### 3.2.1. 発注設定取得

・商品ごとの適正在庫数、最大在庫数、発注ロットなどを取得。

##### 3.2.2. 計算方法別処理

・標準方式：適正在庫数 - 現在在庫数 = 発注数量
・季節変動方式：季節係数を加味した適正在庫数から計算
・予測モデル方式：過去の販売実績から予測モデルによる適正在庫を計算

##### 3.2.3. 発注ロット調整

・計算された発注数量を発注ロット単位に切り上げ調整。

#### 3.3. 発注データ作成

##### 3.3.1. トランザクション開始

・DB登録処理のトランザクション開始。

##### 3.3.2. 発注ヘッダー登録

・発注番号、発注日、ステータス（自動発注）を登録。

##### 3.3.3. 発注明細登録

・商品ごとの発注データ（商品コード、発注数量、単価など）を登録。

##### 3.3.4. コミット

・エラーがなければトランザクションをコミット。

#### 3.4. 発注書作成

##### 3.4.1. 発注先ごとのデータ集計

・発注先別に商品をグループ化。

##### 3.4.2. 発注書PDF生成

・発注先ごとの発注書をPDF形式で生成。
・ファイル名：発注書_発注先コード_YYYYMMDD.pdf

### 4. 後処理

#### 4.1. 発注通知

・発注担当者に発注内容をメール通知。
・発注書PDFを添付。

#### 4.2. 仕入先連携

・発注データを仕入先システムに連携（API連携がある場合）。
・EDI連携用の発注データファイルを生成（必要に応じて）。

#### 4.3. 処理結果ログ出力

・処理件数（発注商品数、発注先数）をログ出力。
・エラー詳細情報を出力。