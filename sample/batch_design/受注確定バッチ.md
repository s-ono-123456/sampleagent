## バッチ名: 受注確定バッチ

外部設計書

| ドキュメント名 | 作成日／更新日 | 版 | 作成者／更新者 |
|---|---|---|---|
| 外部設計書_バッチ設計（受注確定） | 2025-04-26 | 1.0.0 | あなたのお名前 |

### 1. 前処理

#### 1.1. 権限チェック

・バッチ実行アカウントの権限をチェックする。  
・データベース接続権限を確認。

#### 1.2. パラメータ取得

・確定処理対象期間などの情報を取得する。

| ＃ | パラメータ名 | 説明 |
|---|---|---|
| 1 | 対象期間（日数） | 仮登録後、経過日数（デフォルト：3日） |
| 2 | 実行アカウント | バッチ実行アカウント情報 |
| 3 | 除外ステータス | 処理対象外の受注ステータス（カンマ区切り） |

### 2. チェック処理

#### 2.1. 対象データ存在チェック

・確定対象となる受注データが存在するか確認。
・対象データがない場合は処理をスキップし正常終了。

### 3. 業務処理

#### 3.1. 確定対象データ取得

##### 3.1.1. 対象データ抽出

・ステータスが「仮登録」かつ登録日が指定期間（現在日付-対象期間）以前の受注を抽出。
・除外ステータスに該当する受注は対象外。

##### 3.1.2. 確定前チェック

・在庫引当可能かを確認。
・与信限度額を超えていないか確認。
・問題がある受注は対象外としてログに出力。

#### 3.2. 確定処理

##### 3.2.1. トランザクション開始

・DB更新処理のトランザクション開始。

##### 3.2.2. 受注ステータス更新

・対象の受注データのステータスを「確定」に更新。
・確定日時、確定ユーザーIDを設定。

##### 3.2.3. 在庫引当処理

・商品在庫を確保（在庫数から減算）。
・引当テーブルに引当情報を登録。

##### 3.2.4. 売上計上処理

・売上テーブルにデータを登録。
・売上日、売上金額を設定。

##### 3.2.5. コミット

・エラーがなければトランザクションをコミット。

### 4. 後処理

#### 4.1. 確定通知メール送信

・確定された受注の顧客宛に確定通知メールを送信。
・受注内容、確定日、発送予定日を含む。

#### 4.2. 業務担当者通知

・確定された受注の一覧を業務担当者に通知。
・出荷準備の指示情報を含む。

#### 4.3. 処理結果ログ出力

・処理件数（対象件数、確定件数、エラー件数）をログ出力。
・エラー詳細情報を出力。