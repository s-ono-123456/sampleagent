## バッチ名: 受注データ取込バッチ

外部設計書

| ドキュメント名 | 作成日／更新日 | 版 | 作成者／更新者 |
|---|---|---|---|
| 外部設計書_バッチ設計（受注データ取込） | 2025-04-26 | 1.0.0 | あなたのお名前 |

### 1. 前処理

#### 1.1. 権限チェック

・バッチ実行アカウントの権限をチェックする。  
・データベース接続権限を確認。

#### 1.2. パラメータ取得

・取込対象ファイルパス情報を取得する。

| ＃ | パラメータ名 | 説明 |
|---|---|---|
| 1 | 取込ファイルパス | 受注データCSVファイルの配置パス |
| 2 | 実行日 | バッチ実行日（YYYY-MM-DD形式） |
| 3 | 移動先パス | 処理済みファイルの移動先パス |

### 2. チェック処理

#### 2.1. ファイル存在チェック

・指定パスにファイルが存在するか確認。
・ファイルが存在しない場合は警告ログを出力し正常終了。

#### 2.2. ファイルフォーマットチェック

・CSVファイルのヘッダー行が正しいか確認。
・必須項目（受注番号、顧客ID、受注日、商品コード、数量、単価など）が存在するか確認。

### 3. 業務処理

#### 3.1. データ取込処理

##### 3.1.1. CSVファイル読込

・CSVファイルを行単位で読み込み。
・文字コード（UTF-8）、区切り文字（カンマ）を考慮。

##### 3.1.2. データ変換

・CSVデータをDBスキーマに合わせた形式に変換。
・日付フォーマット、数値フォーマットの変換。

##### 3.1.3. 重複チェック

・既存の受注データと受注番号で重複チェック。
・重複がある場合はスキップしログに出力。

#### 3.2. DB登録処理

##### 3.2.1. トランザクション開始

・DB登録処理のトランザクション開始。

##### 3.2.2. 受注テーブル登録

・受注ヘッダー情報をDB登録。
・登録日時、ステータス（仮登録）を設定。

##### 3.2.3. 受注明細テーブル登録

・受注明細情報をDB登録。
・商品マスタ参照し、商品情報を補完。

##### 3.2.4. コミット

・エラーがなければトランザクションをコミット。

### 4. 後処理

#### 4.1. ファイル移動

・処理済みファイルを指定の移動先パスへ移動。
・ファイル名に処理日時を付与（例：受注データ_20250426_153000.csv）。

#### 4.2. 処理結果ログ出力

・処理件数（読込件数、登録件数、エラー件数）をログ出力。
・エラー詳細情報を出力。

#### 4.3. 処理結果メール送信

・処理結果を管理者宛にメール送信。
・正常終了/異常終了、処理件数を含む。