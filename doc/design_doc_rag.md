# 設計書検索RAGアプリケーション設計書

## 1. 概要

このアプリケーションは、設計書に関するユーザーからの質問に対して、設計書群から関連情報を検索し、回答を提供するRAG（Retrieval-Augmented Generation）システムです。既存の`vector_store_loader.py`の関数を活用して、効率的な検索と回答生成を実現します。また、検索結果と生成された回答を画面上に表示することで、ユーザーにとって透明性の高い情報提供を行います。

## 2. 全体アーキテクチャ

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│  ユーザー入力    │────▶│  クエリ処理     │────▶│  ベクトル検索   │
└─────────────────┘     └──────────────────┘     └─────────────────┘
         ▲                                               │
         │                                               ▼
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│  UI表示モジュール │◀────│  回答生成       │◀────│  文書評価・選択 │
└─────────────────┘     └──────────────────┘     └─────────────────┘
```

## 3. コンポーネント設計

### 3.1 クエリ処理モジュール

**機能**:
- ユーザーからの質問を分析
- 検索クエリの最適化
- 検索カテゴリの判定（バッチ設計/画面設計）

**実装詳細**:
- 複数の検索クエリを生成（質問の言い換え）
- カテゴリ判定ロジック（キーワードベース）
- クエリの正規化処理

### 3.2 ベクトル検索モジュール

**機能**:
- `vector_store_loader.py`を活用した文書検索
- 適切なベクトルストアの選択
- 類似度に基づくドキュメント取得

**実装詳細**:
- 既存の関数（`load_vector_stores`、`load_vector_stores_category`）を活用
- カテゴリ指定の有無によるベクトルストア選択ロジック
- 検索結果のスコア付きリスト取得と加工処理

### 3.3 文書評価・選択モジュール

**機能**:
- 検索結果の重複除去
- 関連性スコアに基づく選択
- 文書内容の適切な抽出

**実装詳細**:
- 重複検出アルゴリズム（文書の冒頭部分で判定）
- スコアによるフィルタリング
- 文書からの重要部分抽出

### 3.4 回答生成モジュール

**機能**:
- 検索結果に基づく回答の生成
- 情報の統合と構造化
- 根拠の明示

**実装詳細**:
- LLM（GPT-4.1-nano）を活用した回答生成
- 検索結果をコンテキストとして活用
- 引用元の管理と表示

### 3.5 UI表示モジュール

**機能**:
- チャットインターフェースの提供
- 検索結果と回答の同時表示
- インタラクティブな対話環境

**実装詳細**:
- Streamlitによる実装
- 検索結果と回答を分けて表示するレイアウト
- 質問履歴の管理

## 4. データフロー

1. ユーザーが質問を入力
2. クエリ処理モジュールが質問を分析し、最適な検索クエリを生成
3. 検索クエリとカテゴリ情報に基づいてベクトル検索を実行
   - 複数クエリからの検索結果を統合
4. 文書評価・選択モジュールが検索結果を評価・選別
   - 重複を除去
   - 関連性の高いドキュメントを選択
5. 回答生成モジュールが検索結果を基に回答を生成
6. UI表示モジュールが検索結果と回答を画面に表示
7. ユーザーからの追加質問に対して、プロセスを繰り返す

## 5. ユーザーインターフェース設計

```
┌───────────────────────────────────────────────────────────────┐
│  設計書検索アシスタント                                  [□][×]│
├───────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌───────────────────────────────────────────────────────┐   │
│  │ [チャット] [検索結果]                                  │   │
│  ├───────────────────────────────────────────────────────┤   │
│  │                                                       │   │
│  │ /* チャットタブの内容 */                              │   │
│  │ ユーザー:                                             │   │
│  │ 受注確定バッチの処理内容はどうなっていますか？         │   │
│  │                                                       │   │
│  │ アシスタント:                                         │   │
│  │ 受注確定バッチは、次の処理を行います...                │   │
│  │                                                       │   │
│  │ /* 検索結果タブの内容（非表示） */                     │   │
│  │ 【ドキュメント1】                                     │   │
│  │ ファイル: 受注確定バッチ.md                           │   │
│  │ スコア: 0.89                                          │   │
│  │ 内容: 受注確定バッチは毎日夜間に実行され...            │   │
│  │                                                       │   │
│  │ 【ドキュメント2】                                     │   │
│  │ ...                                                   │   │
│  └───────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌───────────────────────────────────────────────────────┐   │
│  │ メッセージを入力                                  送信 │   │
│  └───────────────────────────────────────────────────────┘   │
│                                                               │
└───────────────────────────────────────────────────────────────┘
```

### 5.1 UI要素の説明

1. **タブナビゲーション**
   - チャットタブ: 対話履歴を表示するデフォルトタブ
   - 検索結果タブ: 現在の質問に関連する検索結果を表示するタブ

2. **チャットタブ**
   - ユーザーとアシスタントの対話履歴を表示
   - 過去の質問と回答をスクロール可能に表示
   - メッセージの送信者を視覚的に区別（アイコンや色で差別化）

3. **検索結果タブ**
   - 現在の質問に関連する検索結果をリスト表示
   - ドキュメント名、類似度スコア、抽出内容を表示
   - 複数の検索結果を折りたたみ形式で表示
   - 各ドキュメントの詳細展開機能

4. **入力フィールド**
   - ユーザーが質問を入力するテキストボックス
   - 送信ボタンで質問を送信
   - タブに関わらず常に表示される固定要素

5. **オプション設定**（サイドバーに配置）
   - 検索カテゴリの選択（バッチ設計/画面設計/全て）
   - 表示する検索結果数の調整
   - モデル選択（回答生成用）
   - UIテーマの切り替え（ライト/ダーク）

### 5.2 タブ切り替えの利点

1. **スペースの効率的利用**
   - 限られた画面スペースを有効活用
   - 各機能に十分な表示領域を確保

2. **ユーザーの集中をサポート**
   - 会話に集中したいときはチャットタブ
   - 検索結果の詳細を確認したいときは検索結果タブ

3. **情報の整理**
   - 関連する情報を論理的にグループ化
   - 情報過多による認知負荷の軽減

4. **柔軟な情報アクセス**
   - ワンクリックで異なる情報セットにアクセス可能
   - ユーザーの作業文脈に応じた表示の切り替え

## 6. 実装詳細

### 6.1 主要クラス構成

- **RAGQueryProcessor**:
  - クエリ処理を担当するクラス
  - 質問分析と最適な検索クエリの生成
  - カテゴリ判定ロジック

- **RAGRetriever**:
  - 文書検索を担当するクラス
  - ベクトル検索の実行
  - 複数クエリからの結果統合

- **RAGGenerator**:
  - 回答生成を担当するクラス
  - 検索結果に基づく回答生成

- **RAGApp**:
  - アプリケーション全体を統括するクラス
  - 処理フローの調整と実行

### 6.2 主要関数

- **create_search_queries**:
  - ユーザーの質問から複数の検索クエリを生成する関数
  - LLMを使用した言い換えにより検索の多様性を確保

- **format_search_results**:
  - 検索結果を表示用にフォーマットする関数
  - 一貫性のある表示形式の提供

- **generate_prompt**:
  - 回答生成用のプロンプトを作成する関数
  - 検索結果を適切に組み込んだプロンプト構築

### 6.3 Streamlitによる実装

**主要コンポーネント**:
- タイトルとサイドバー設定（カテゴリ、検索結果数、モデル選択）
- チャット履歴の管理と表示
- 検索結果表示用エクスパンダー
- 質問入力とレスポンス処理
- 処理状態表示（ステータスインジケータ）

## 7. エラー処理

### 7.1 想定されるエラーと対応

| エラー | 対応策 |
|------|------|
| ベクトルインデックスが見つからない | エラーメッセージを表示し、デフォルトのテキスト検索にフォールバック |
| 埋め込みモデルのロードエラー | 代替の埋め込みモデルを使用、またはシンプルなキーワード検索にフォールバック |
| 類似度検索結果が空の場合 | 一般的な回答を提供し、質問の言い換えを提案 |
| LLMの応答エラー | エラーメッセージを表示し、検索結果のみを提示 |
| アプリケーションの予期せぬエラー | エラーログ記録と優雅な失敗処理 |

### 7.2 エラー処理戦略

- エラーハンドリング付きのベクトル検索関数の実装
- 例外発生時の適切なフォールバックメカニズム
- エラーログ記録による問題追跡
- ユーザーへの適切なフィードバック提供

## 8. 拡張可能性

### 8.1 機能拡張

1. **マルチモーダル対応**
   - 図表や図面の理解と説明機能
   - 設計書内の図表参照機能

2. **インタラクティブな検索フィルタリング**
   - ユーザーが検索結果を動的にフィルタリング可能に
   - 関連度や日付によるソート機能

3. **会話履歴を活用した文脈理解**
   - 過去の質問と回答を考慮した回答生成
   - ユーザーの関心領域の学習と活用

4. **定期的な設計書インデックス更新機能**
   - 新規設計書の自動インデックス化
   - インデックスの鮮度維持機能

### 8.2 技術的拡張

1. **複数の埋め込みモデルの活用**
   - 目的に応じた最適な埋め込みモデルの選択
   - ハイブリッド検索アプローチの導入

2. **分散システムへのスケーリング**
   - 大規模設計書コレクション対応
   - 検索と生成のマイクロサービス化

3. **パフォーマンス最適化**
   - クエリキャッシング
   - 検索結果のプリフェッチ
   - 埋め込み計算の最適化

## 9. まとめ

この設計書に基づいたRAGアプリケーションは、既存の`vector_store_loader.py`関数を活用して、設計書に関するユーザーの質問に効率的に回答します。ベクトル検索とLLMを組み合わせることで、単なる検索エンジンを超えた、文脈を理解した回答を提供します。また、検索結果と回答を同時に表示することで、ユーザーは回答の根拠を確認しながら情報を得ることができます。

Streamlitを活用したUIにより、直感的なチャットインターフェースでユーザーとの対話を実現し、エラー処理や拡張性を考慮した実装により、堅牢で発展性のあるシステムとなっています。