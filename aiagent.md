本文章はOpenAIが公開している以下テキストを和訳したものです。

https://cdn.openai.com/business-guides-and-resources/a-practical-guide-to-building-agents.pdf

---

# エージェント構築の実践ガイド

---

## 目次  
- エージェントとは？ 4  
- いつエージェントを構築すべきか？ 5  
- エージェント設計の基礎 7  
- ガードレール（安全対策） 24  
- 結論 32  

---

## はじめに  
大規模言語モデル（LLM）は複雑で多段階のタスクを扱う能力が向上しています。  
推論、多様なモーダリティ対応、ツール利用の進化により、エージェントと呼ばれる新しい種類のLLM駆動システムが実現可能になりました。  

本ガイドは、初めてエージェントを構築しようと考えているプロダクトおよびエンジニアリングチーム向けに、数多くの導入事例から得た知見を実践的かつ行動可能なベストプラクティスにまとめたものです。  
有望なユースケースの見極め、エージェントロジックとオーケストレーション設計のパターン、安全で予測可能かつ効果的に動作させるための指針を提供します。  

このガイドを読むことで、初めてのエージェント構築に必要な基礎知識を得ることができます。  

---

## エージェントとは？  
従来のソフトウェアがユーザーの業務を効率化・自動化するのに対し、  
エージェントはユーザーに代わって自律的に同じ業務を遂行します。  

エージェントはユーザーの目標達成のために、複数のステップからなるワークフローを独立して完了させるシステムです。  
（例：顧客対応問題の解決、レストラン予約、コード変更のコミット、レポート作成など）  

単にLLMを組み込んでいても、ワークフロー制御をLLMに任せていないチャットボットや単一ターンのLLM、感情分類器はエージェントとは呼びません。  

具体的には、以下の特徴を備えます：  
1. LLMを用いてワークフローを管理し意思決定を行う。ワークフロー完了を認識し、必要に応じて自主的に修正や中断し、ユーザーに制御を戻せる。  
2. 外部システムと連携するツールを複数持ち、ワークフローの状況に応じて適切なツールを動的に選択。明確な安全対策（ガードレール）の範囲内で動作する。  

---

## いつエージェントを構築すべきか？  
エージェントは、従来の決定論的・ルールベースのアプローチが困難な複雑なワークフローに特に適しています。  

例：  
決済詐欺分析。従来のルールエンジンはチェックリスト的に判定するのに対し、LLMエージェントは文脈や微妙なパターンを考慮し、明確なルール違反がなくとも不審な活動を特定するなど、探偵のような役割を果たします。  

価値を生む箇所としては、以下のような自動化が困難なワークフローを優先してください。  

1. 複雑な意思決定  
例：顧客対応での返金承認など、繊細な判断や例外、文脈依存が必要なケース。  
2. 保守が困難なルール群  
例：複雑なルールセットで管理が煩雑、更新が高コストなベンダーセキュリティレビューなど。  
3. 非構造化データへの依存が重い場合  
例：自然言語文書の解釈、会話的インタラクションを伴う保険請求処理など。  

該当するか検証し、必要がなければ決定論的な解決方法で十分なケースもあります。  

---

## エージェント設計の基礎  
エージェントは基本的に以下の3要素から構成されます。  

1. モデル（LLM）  
2. ツール（外部APIや機能）  
3. 指示（エージェントの振る舞いを定義するガイドライン）  

（コード例はOpenAIのAgents SDKを使用したものが紹介されています）

### モデル選択  
- タスクの複雑さ、遅延、コストに応じてモデルを使い分ける  
- シンプルなタスクなら小型高速モデル、難しい意思決定は高性能モデルを使うのが良い  
- まず高性能モデルでプロトタイプを作り、必要に応じてより小さいモデルに入れ替える方法が効果的  

### ツール定義  
- ツールは必要な情報取得や外部アクションを行うAPIや機能  
- 例：データ検索、CRM操作、メール送信など  
- ツールは標準化されており、複数エージェントで再利用可能であるべき  
- 多数のツールが必要な場合は複数エージェントへの分割も検討    

### 指示の設定  
- 明確で曖昧さの少ない指示を用意し、細かくタスクを分割しながら明示的なステップを指定  
- 実際の利用に伴い、エッジケース（例外条件や欠損情報の扱いなど）を考慮した条件分岐を含めるべき  
- 大型モデルを使って既存文書から指示を自動生成することも可能  

---

## オーケストレーション（複数エージェントの連携設計）  
- シングルエージェント方式：1つのエージェントがツールを使い分けて遂行  
- マルチエージェント方式：複数のエージェントが役割分担し、協調して遂行  

### シングルエージェント  
- 増えるツールに対応しやすく、管理がシンプル  
- プロンプトテンプレートで柔軟な構成をするとメンテが楽  

### マルチエージェント  
- 複雑なタスク分割や複数役割分担に適す  
- 「マネージャーパターン」中央エージェントがタスクを分配  
- 「分散パターン」複数エージェント間で直接ワークフローをハンドオフ  

---

## ガードレール（安全策）  
- プライバシー保護やブランド毀損防止などのリスク管理対策  
- LLMベースの安全チェック、ルールベース（正規表現など）、OpenAIのモデレーションAPIの組み合わせで多層防御を構築  
- ガードレールの例：  
  - 関連性判定（話題ズレ検出）  
  - 安全性判定（プロンプトインジェクション検出）  
  - 個人識別情報（PII）フィルタ  
  - モデレーション（暴言や差別的発言検出）  
  - ツール毎のリスク評価（操作権限や財務影響度に基づく）  
  - 固定ルール（ブラックリスト、入力長制限、SQLインジェクション対策など）  
  - 出力検証（ブランド価値に沿っているかのチェック）  

### ヒューマンインターベンション  
- エージェントが失敗時や高リスク行動時に人間の判断を介入させる仕組みも重要  
- 失敗許容回数超過や高リスク操作（注文キャンセル、大きな返金など）には必ず人間介入推奨  

---

## 結論  
エージェントは複雑な意思決定や非構造化データを扱うワークフローの自動化に新たな可能性をもたらします。  
強力なモデル、明確なツール、構造化された指示を基盤とし、適切なオーケストレーションと充実したガードレールを備える