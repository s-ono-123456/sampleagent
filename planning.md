# エージェント設計

## 1. 概要

このエージェントは、ユーザーからの質問に対して、多数の設計書類から適切な情報を検索・抽出し、回答を提供するシステムです。

## 2. 処理フロー

1. **質問受付**
   - ユーザーからの質問を受け付ける
   - 質問の意図と必要情報を分析する

2. **関連設計書の検索**
   - 質問内容に基づいて、関連する可能性がある設計書を特定する
   - ベクトル検索などを用いて類似度の高い設計書を抽出する

3. **情報の評価と選択**
   - 検索された設計書の内容を確認する
   - 質問への回答に必要な情報かを判断する
   - 不要な情報を除外し、必要な情報を選択する

4. **情報の補完**
   - 必要に応じて追加の設計書を検索する
   - 情報が不足している場合は再検索を行う

5. **回答生成**
   - 収集した情報を統合し、ユーザーの質問に適した回答を生成する
   - わかりやすく整理された形で回答を提供する

## 3. 技術要素

- **自然言語処理**
  - 質問の意図理解
  - 情報の関連性評価
  - 回答文生成

- **ベクトル検索**
  - 設計書のベクトル化
  - 類似度に基づく文書検索

- **情報抽出**
  - 設計書からの重要情報抽出
  - 不要情報のフィルタリング

## 4. アーキテクチャ

```
[ユーザー] → [質問受付モジュール] → [検索モジュール] → [情報評価モジュール]
                                      ↑                  ↓
                                      └──[情報補完モジュール]──→ [回答生成モジュール] → [ユーザー]
```

## 5. 実装方針

- 既存の`vector_store_loader.py`を活用して設計書のベクトル検索を実装
- `document_vectorizer.py`を用いて設計書のインデックス化を行う
- 回答生成には適切なLLMを使用し、検索結果をコンテキストとして提供する
- ユーザーとのインタラクションを管理するエージェントモジュールを実装する

## 6. 評価指標

- 回答の正確性
- 検索の網羅性
- 応答時間
- ユーザー満足度

## 7. 今後の拡張可能性

- 設計書の自動更新機能
- ユーザーフィードバックに基づく学習機能
- マルチモーダル対応（図面や図表の理解）
- 対話型インターフェースの強化

## 8. 必要なエージェント構成

処理フローに基づいて、以下の専用エージェントが必要となります。

### 8.1 コントローラーエージェント（Controller Agent）
- **役割**: 全体の処理フローを制御し、各専門エージェントを調整する
- **入力**: ユーザーからの質問
- **出力**: 最終的な回答
- **処理内容**:
  - 質問の初期分析
  - 適切なエージェントの呼び出し順序の決定
  - エージェント間の情報連携
  - 全体プロセスの監視と調整

### 8.2 質問分析エージェント（Query Analyzer Agent）
- **役割**: ユーザーからの質問を分析し、必要な情報を特定する
- **入力**: ユーザーの質問文
- **出力**: 
  - 質問の意図カテゴリ（バッチ設計に関する質問か画面設計に関する質問か等）
  - 検索キーワード
  - 必要情報の種類
- **処理内容**:
  - 自然言語処理による質問文の解析
  - 質問のカテゴリ分類
  - 重要キーワードの抽出
  - 検索クエリの生成

### 8.3 検索エージェント（Search Agent）
- **役割**: 適切な設計書を検索・取得する
- **入力**: 検索クエリ、情報カテゴリ
- **出力**: 関連設計書リスト
- **処理内容**:
  - FAISSベクトルデータベース検索
  - 検索対象の選択（バッチ設計/画面設計）
  - vector_store_loader.pyを活用した検索実行
  - 類似度スコアに基づくランキング

### 8.4 情報評価エージェント（Information Evaluator Agent）
- **役割**: 検索結果から関連性の高い情報を評価・選択する
- **入力**: 関連設計書リスト、元の質問
- **出力**: 評価済み情報リスト（関連度スコア付き）
- **処理内容**:
  - 検索結果の内容確認
  - 質問との関連性評価
  - 重要情報の選別
  - 情報の正規化と構造化

### 8.5 情報補完エージェント（Information Completer Agent）
- **役割**: 不足情報を特定し追加検索を行う
- **入力**: 評価済み情報リスト、元の質問
- **出力**: 補完された情報セット
- **処理内容**:
  - 情報ギャップの分析
  - 追加検索クエリの生成
  - 検索エージェントの再呼び出し
  - 新規情報と既存情報の統合

### 8.6 回答生成エージェント（Response Generator Agent）
- **役割**: 収集した情報から回答を生成する
- **入力**: 補完された情報セット、元の質問
- **出力**: ユーザーへの最終回答
- **処理内容**:
  - 情報の統合と要約
  - 構造化された回答の生成
  - 回答の妥当性確認
  - 引用元の明示

## 9. エージェント間連携フロー

```
[ユーザー質問]
      ↓
[コントローラーエージェント] ← → [質問分析エージェント]
      ↓
   [検索エージェント]
      ↓
[情報評価エージェント]
      ↓
      ↓ ←(必要に応じて繰り返し)
      ↓
[情報補完エージェント] → [検索エージェント]
      ↓
[回答生成エージェント]
      ↓
 [最終回答をユーザーに提供]
```

## 10. 実装上の注意点

- 各エージェントは独立したモジュールとして実装し、明確なインターフェースを定義する
- エージェント間の通信は標準化された形式で行う
- 状態管理を適切に行い、処理の途中経過を追跡可能にする
- エラーハンドリングを各エージェントに実装し、障害耐性を確保する
- ログ機能を充実させ、デバッグと性能分析を容易にする
